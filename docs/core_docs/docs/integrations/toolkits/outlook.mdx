# Outlook Toolkit

## Overview

Using this toolkit, you can integrate Microsoft Graph API functionalities into 
your applications to manage email interactions.

## Learn Microsoft Graph

Microsoft Graph is a RESTful web API that enables you to access Microsoft 
Cloud service resources. With Microsoft Graph, you can integrate various 
Microsoft services and data, including users' emails, calendar, contacts, 
and more, into your applications.

After you register your app and get authentication tokens for a user or service, 
you can make requests to the Microsoft Graph API.

How to get authentication tokens for a user:   
https://learn.microsoft.com/en-us/graph/auth-v2-user

## Set up

An `accessToken` is needed to use the Outlook Toolkit.

You need to first register an application in Azure Portal to obtain
necessary credentials.

### App register

1. Register an Application:
   - Go to Azure Portal.
   - Navigate to Azure Active Directory -> App registrations.
   - Register a new application, note down the Client ID.

2. Generate Client Secret:
   - In the application settings, go to Certificates & Secrets.
   - Create a new client secret and note down the Client Secret.

3. Configure Redirect URI:
   - In the application settings, go to Authentication.
   - Add a Redirect URI and note down the Redirect URI.

4. Permissions and Admin Consent:
   - In API permissions, grant necessary permissions for Microsoft Graph API or 
   Outlook API.
   - Grant admin consent for the added permissions.

At this point, you should have these three credentials:
clientId, clientSecret, redirectUri

Set them as environment variables:

  ```env
  OUTLOOK_CLIENT_ID=your_client_id
  OUTLOOK_CLIENT_SECRET=your_client_secret
  OUTLOOK_REDIRECT_URI=your_redirect_uri
  ```
  **Keep these values secure and avoid exposing them in public repositories.**

The following link from Microsoft is a good reference for the above steps:
https://learn.microsoft.com/en-us/graph/auth-v2-user

This video may also be helpful:
https://www.youtube.com/watch?v=NAtiNpwnivI&t=309s


     OUTLOOK_ACCESS_TOKEN=your_access_token
     // for AuthFlowToken
     OUTLOOK_REFRESH_TOKEN=your_refresh_token

     ```

### Get an accessToken

Now you are able to use the above credentials to get an `accessToken`.

The `AuthFlowREST` class implements the OAuth 2.0 authorization code flow.
You can use the `getAccessToken()` which will open a temporary server on 
your `redirectUri` and you need to manually open the printed link to login 
on behalf of the user. For every `AuthFlowREST` instance, you only need to 
login once. The next time you can run the `refreshAccessToken()` method, it will
make use of the `refreshToken` obtained together with the first `accessToken`
 to get a new `accessToken` without the need of the server and login.

Having the above credentials, you can either pass them to the constructor 
or put them in the environment.

```typescript
const authFlow = new AuthFlowREST();
const authFlow = new AuthFlowREST(clientId, clientSecret, redirectUri);
// Get accessToken
const accessToken = await authFlow.getAccessToken();
// After the above line, you can get the refreshToken
const refreshToken = authFlow.getRefreshToken();
// Refresh accessToken
const accessToken = await authFlow.refreshAccessToken();
```

### Provide accessToken to Outlook Toolkit

The Outlook Toolkit needs `AuthFlow` abstarct class to provide accessToken.

```typescript
const authFlow = new AuthFlowREST();
const outlookReadMail = new OutlookReadMailTool(authFlow=authFlow);
// or simply this when you have the credentials in .env
const outlookReadMail = new OutlookReadMailTool(choice="rest");
```

### Other classes to provide accessToken

If you only have a valid `accessToken` in your env:

```typescript
const authFlow = new AuthFlowToken(accessToken);
// if you have accessToken stored in .env
const authFlow = new AuthFlowToken();
const outlookReadMail = new OutlookReadMailTool(authFlow=authFlow);
// or simply this when you have accessToken in .env
const outlookReadMail = new OutlookReadMailTool(choice="token");
```

Usually when you obtain a accessToken you also get a refreshToken 
used to refresh expired accessToken. The `AuthFlowREST` class needs 
the following credentials: `clientId`, `clientSecret`, `redirectUri` 
and `refreshToken`. In this way you won't need to login, no server 
will be open.

```typescript
const authFlow = new AuthFlowRefresh();
const outlookReadMail = new OutlookReadMailTool(authFlow=authFlow);
// or simply this when you have the credentials in .env
const outlookReadMail = new OutlookReadMailTool(choice="refresh");
```

## Usage

This example shows how to read emails by using agent.

```typescript
import { ChatOpenAI } from 'langchain/chat_models/openai';
import { initializeAgentExecutorWithOptions } from 'langchain/agents';
import { OutlookReadMailTool } from '@langchain/community/tools/outlook';
require('dotenv').config();

async function createAndRunAgent() {
  const gpt4 = new ChatOpenAI({ modelName: 'gpt-3.5-turbo-1106', openAIApiKey: process.env.OPENAI_API_KEY});

  const outlookReadMail = new OutlookReadMailTool(undefined, "token");

  const executor = await initializeAgentExecutorWithOptions([outlookReadMail], gpt4, {
    agentType: "openai-functions",
    verbose: true,
  });

  const input = 'show my emails';
  const result = await executor.invoke({ input });

  console.log(result);
}

createAndRunAgent();
```

This example shows how to send emails by using agent.

```typescript
import { ChatOpenAI } from 'langchain/chat_models/openai';
import { initializeAgentExecutorWithOptions } from 'langchain/agents';
import { OutlookSendMailTool } from '@langchain/community/tools/outlook';
require('dotenv').config();

async function createAndRunAgent() {
  const gpt4 = new ChatOpenAI({ modelName: 'gpt-4', openAIApiKey: process.env.OPENAI_API_KEY});

  const sendMailTool = new OutlookSendMailTool(undefined, "token");

  const executor = await initializeAgentExecutorWithOptions([sendMailTool], gpt4, {
    agentType: "openai-functions",
    verbose: true,
  });

  const input = 'send an email to YOUR_EMAIL and invite him to a meeting at 3pm tomorrow';
  const result = await executor.invoke({ input });

  console.log(result);
}

createAndRunAgent();
```
